<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllOneAI</title>
    <!-- Tailwind CSS CDN para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 48rem; /* Aumenta a largura máxima para uma melhor experiência de chat */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .chat-container {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            background-color: #f9fafb;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            text-align: left;
        }
        .chat-message {
            padding: 0.6rem 1rem;
            border-radius: 0.75rem;
            max-width: 80%;
        }
        .user-message {
            background-color: #dbeafe;
            color: #1e40af;
            align-self: flex-end;
        }
        .ai-message {
            background-color: #e0f2fe;
            color: #0c4a6e;
            align-self: flex-start;
        }
        .loading-indicator {
            text-align: center;
            padding: 1rem;
            color: #4b5563;
        }
        .error-message {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        .access-card {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
        }
        /* Remover a exibição do ID do usuário no chat */
        .user-id-display {
            display: none; /* Oculta totalmente o elemento */
        }
        .info-message {
            background-color: #ecfdf5; /* Esverdeado para sucesso/informação */
            color: #065f46;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold mb-4 text-gray-800 text-center">AI Chat Multi-LLM</h1>
        
        <div id="authSection" class="access-card">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Acesso ao Chat AI</h2>
            <div class="mb-4">
                <label for="accessKeyInput" class="block text-gray-700 text-sm font-semibold mb-2 text-left">
                    Seu ID de Usuário (Chave de Acesso):
                </label>
                <input type="text" id="accessKeyInput" class="input-field" placeholder="Cole seu ID de usuário aqui">
            </div>
            <button id="validateAccessBtn" class="btn-primary w-full">Validar Acesso</button>
            <div id="accessMessage" class="message-box hidden mt-4"></div>
            <!-- O elemento currentUserIdDisplay foi ocultado via CSS e o preenchimento automático removido -->
            <div class="user-id-display mt-4 hidden" id="currentUserIdDisplay">
                <strong>Seu ID de Usuário (Firebase):</strong> <span id="displayedUserId"></span>
            </div>
        </div>

        <div id="chatSection" class="hidden">
            <div class="mb-4">
                <label for="modelSelect" class="block text-gray-700 text-sm font-semibold mb-2 text-left">
                    Selecione o Modelo LLM:
                </label>
                <select id="modelSelect" class="input-field">
                    <!-- Lista de modelos fornecida pelo usuário -->
                    <option value="google/gemini-2.0-flash-001">google/gemini-2.0-flash-001</option>
                    <option value="google/gemini-2.0-flash-exp:free">google/gemini-2.0-flash-exp:free</option>
                    <option value="google/gemini-2.0-flash-lite-001">google/gemini-2.0-flash-lite-001</option>
                    <option value="google/gemini-2.5-flash">google/gemini-2.5-flash</option>
                    <option value="google/gemini-2.5-flash-lite-preview-06-17">google/gemini-2.5-flash-lite-preview-06-17</option>
                    <option value="google/gemini-2.5-flash-preview">google/gemini-2.5-flash-preview</option>
                    <option value="google/gemini-2.5-flash-preview-05-20">google/gemini-2.5-flash-preview-05-20</option>
                    <option value="google/gemini-2.5-flash-preview-05-20:thinking">google/gemini-2.5-flash-preview-05-20:thinking</option>
                    <option value="google/gemini-2.5-flash-preview:thinking">google/gemini-2.5-flash-preview:thinking</option>
                    <option value="google/gemini-2.5-pro">google/gemini-2.5-pro</option>
                    <option value="google/gemini-2.5-pro-exp-03-25">google/gemini-2.5-pro-exp-03-25</option>
                    <option value="google/gemini-2.5-pro-preview">google/gemini-2.5-pro-preview</option>
                    <option value="google/gemini-2.5-pro-preview-05-06">google/gemini-2.5-pro-preview-05-06</option>
                    <option value="google/gemini-flash-1.5">google/gemini-flash-1.5</option>
                    <option value="google/gemini-flash-1.5-8b">google/gemini-flash-1.5-8b</option>
                    <option value="google/gemini-pro-1.5">google/gemini-pro-1.5</option>
                    <option value="gpt-5">gpt-5</option>
                    <option value="gpt-5-mini">gpt-5-mini</option>
                    <option value="gpt-5-nano">gpt-5-nano</option>
                    <option value="gpt-5-chat-latest">gpt-5-chat-latest</option>
                    <option value="gpt-4.1">gpt-4.1</option>
                    <option value="gpt-4.1-mini">gpt-4.1-mini</option>
                    <option value="gpt-4.1-nano">gpt-4.1-nano</option>
                    <option value="gpt-4.5-preview">gpt-4.5-preview</option>
                    <option value="gpt-4o">gpt-4o</option>
                    <option value="gpt-4o-mini">gpt-4o-mini</option>
                    <option value="o1">o1</option>
                    <option value="o1-mini">o1-mini</option>
                    <option value="o1-pro">o1-pro</option>
                    <option value="o3">o3</option>
                    <option value="o3-mini">o3-mini</option>
                    <option value="o4-mini">o4-mini</option>
                    <option value="x-ai/grok-3">x-ai/grok-3</option>
                    <option value="x-ai/grok-3-beta">x-ai/grok-3-beta</option>
                    <option value="x-ai/grok-3-mini">x-ai/grok-3-mini</option>
                    <option value="x-ai/grok-3-mini-beta">x-ai/grok-3-mini-beta</option>
                    <option value="x-ai/grok-4">x-ai/grok-4</option>
                </select>
            </div>

            <div id="chatHistory" class="chat-container">
                <!-- As mensagens do chat serão adicionadas aqui -->
            </div>

            <div class="flex items-center gap-4 mt-4">
                <input type="text" id="promptInput" class="input-field flex-grow" placeholder="Digite sua mensagem...">
                <button id="sendBtn" class="btn-primary">Enviar</button>
            </div>
            <div id="chatLoadingIndicator" class="loading-indicator hidden">Carregando...</div>
        </div>
    </div>

    <!-- SDK do Puter -->
    <script src="https://js.puter.com/v2/"></script>
    
    <!-- SDKs do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase
        // O __firebase_config e __initial_auth_token são fornecidos pelo ambiente Canvas.
        // Se estiver rodando fora do Canvas, você precisará defini-los.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAGE6USqp6YwLpGinnMqZD_eO_gF7m9TRw",
            authDomain: "alloneai-d6ba6.firebaseapp.com",
            databaseURL: "https://alloneai-d6ba6-default-rtdb.firebaseio.com",
            projectId: "alloneai-d6ba6",
            storageBucket: "alloneai-d6ba6.firebasestorage.app",
            messagingSenderId: "695268266235",
            appId: "1:695268266235:web:b8c9a1b96efbfa180e205e",
            measurementId: "G-P4XBLRYG5Y"
        };
        
        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Obtém o ID do aplicativo fornecido pelo ambiente Canvas ou usa um padrão
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const authSection = document.getElementById('authSection');
        const chatSection = document.getElementById('chatSection');
        const accessKeyInput = document.getElementById('accessKeyInput');
        const validateAccessBtn = document.getElementById('validateAccessBtn');
        const accessMessage = document.getElementById('accessMessage');
        const currentUserIdDisplay = document.getElementById('currentUserIdDisplay'); // Este elemento está oculto via CSS

        const modelSelect = document.getElementById('modelSelect');
        const promptInput = document.getElementById('promptInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatHistory = document.getElementById('chatHistory');
        const chatLoadingIndicator = document.getElementById('chatLoadingIndicator');

        // Função para exibir mensagens na seção de acesso
        function showAccessMessage(text, isError = false) {
            accessMessage.textContent = text;
            accessMessage.classList.remove('hidden');
            if (isError) {
                accessMessage.style.backgroundColor = '#fee2e2';
                accessMessage.style.color = '#991b1b';
            } else {
                accessMessage.style.backgroundColor = '#e0f2fe';
                accessMessage.style.color = '#0c4a6e';
            }
        }

        // Função para mostrar o indicador de carregamento do chat
        function showChatLoading(show) {
            chatLoadingIndicator.classList.toggle('hidden', !show);
        }

        // Função para adicionar uma mensagem ao histórico do chat
        function addMessageToChat(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            if (sender === 'user') {
                messageDiv.classList.add('user-message');
            } else {
                messageDiv.classList.add('ai-message');
            }
            messageDiv.textContent = message;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Rola para o final do chat
        }

        // Valida a chave de acesso
        validateAccessBtn.addEventListener('click', async () => {
            const enteredKey = accessKeyInput.value.trim();
            if (!enteredKey) {
                showAccessMessage("Por favor, insira um ID de Usuário (chave de acesso).", true);
                return;
            }

            const accessKeysRef = collection(db, `artifacts/${appId}/public/data/access_keys`);
            const q = query(accessKeysRef, where("userId", "==", enteredKey));

            try {
                const querySnapshot = await getDocs(q);
                let accessGranted = false;
                if (!querySnapshot.empty) {
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const expirationTime = data.expiration;
                        if (expirationTime && Date.now() < expirationTime) {
                            accessGranted = true;
                        }
                    });
                }

                if (accessGranted) {
                    showAccessMessage("Acesso concedido! Você pode começar a conversar com a IA.", false);
                    authSection.classList.add('hidden');
                    chatSection.classList.remove('hidden');
                } else {
                    showAccessMessage("Chave de acesso inválida ou expirada. Por favor, tente novamente ou gere uma nova chave.", true);
                    chatSection.classList.add('hidden');
                    authSection.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Erro ao validar chave de acesso:", error);
                showAccessMessage(`Erro ao validar chave de acesso: ${error.message}. Por favor, verifique suas Regras de Segurança do Firestore.`, true);
                chatSection.classList.add('hidden');
                authSection.classList.remove('hidden');
            }
        });

        // Lida com o envio de mensagens do chat
        sendBtn.addEventListener('click', async () => {
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            const selectedModel = modelSelect.value;
            addMessageToChat(`Você: ${prompt}`, 'user');
            promptInput.value = '';
            showChatLoading(true);

            try {
                let retryCount = 0;
                const maxRetries = 5;
                const baseDelay = 1000;

                let response;
                while (retryCount < maxRetries) {
                    try {
                        response = await puter.ai.chat(prompt, {
                            model: selectedModel
                        });
                        break;
                    } catch (error) {
                        if (error.status === 429 && retryCount < maxRetries - 1) {
                            const delay = baseDelay * Math.pow(2, retryCount);
                            console.warn(`Limite de taxa excedido. Tentando novamente em ${delay / 1000} segundos...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retryCount++;
                        } else {
                            throw error;
                        }
                    }
                }

                if (response && response.message && response.message.content) {
                    addMessageToChat(`IA (${selectedModel}): ${response.message.content}`, 'ai');
                } else {
                    addMessageToChat(`IA (${selectedModel}): Não foi possível obter uma resposta válida.`, 'ai');
                }
            } catch (error) {
                console.error("Erro ao chamar a API Puter AI:", error);
                addMessageToChat(`IA (${selectedModel}): Ocorreu um erro ao processar sua solicitação: ${error.message}`, 'ai');
            } finally {
                showChatLoading(false);
            }
        });

        // Inicializa a Autenticação Firebase (apenas para obter o UID para criar chaves, não para exibir)
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                console.log("Nenhum usuário Firebase autenticado. Tentando autenticação anônima...");
                signInAnonymously(auth).catch(error => {
                    console.error("Erro na autenticação anônima Firebase:", error);
                    showAccessMessage(`Erro na autenticação Firebase: ${error.message}. Verifique a configuração do Firebase.`, true);
                    validateAccessBtn.disabled = true;
                });
            }
        });
    </script>
</body>
</html>
