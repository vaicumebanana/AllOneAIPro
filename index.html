<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All-in-One AI Chat</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinha ao topo */
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
            overflow-y: auto; /* Permite rolagem para conte√∫do */
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* Mais cantos arredondados */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            max-width: 900px; /* Largura m√°xima aumentada */
            width: 100%;
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Permite cliques quando escondido */
        }
        .message-box.show {
            opacity: 1;
            pointer-events: auto;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos da Sobreposi√ß√£o de Login */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Acima de tudo */
            transition: opacity 0.3s ease-in-out;
        }
        .login-box {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
            max-width: 450px;
            width: 90%;
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            text-align: center;
        }
        .hidden {
            display: none !important;
        }
        .chat-message {
            margin-bottom: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            max-width: 80%;
            word-wrap: break-word; /* Garante que o texto quebre linhas */
        }
        .user-message {
            background-color: #dbeafe; /* bg-blue-100 */
            align-self: flex-end;
            margin-left: auto;
        }
        .ai-message {
            background-color: #e2e8f0; /* bg-gray-200 */
            align-self: flex-start;
            margin-right: auto;
        }
    </style>
</head>
<body class="selection:bg-blue-200">
    <!-- Sobreposi√ß√£o de Login -->
    <div id="login-overlay">
        <div class="login-box">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">üîê Acesso √† IA</h1>
            <p class="text-gray-600 mb-6">Por favor, insira sua chave de acesso para continuar.</p>
            <input type="text" id="access-key-input" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-gray-800 shadow-sm text-center" placeholder="Sua Chave de Acesso">
            <button id="login-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                Entrar
            </button>
            <p id="login-error-message" class="text-red-600 mt-4 hidden">Mensagem de erro aqui.</p>
        </div>
    </div>

    <!-- Container Principal do Chat (Inicialmente Escondido) -->
    <div id="chat-container" class="container hidden">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">ü§ñ All-in-One AI Chat</h1>
        <p class="text-center text-gray-500 text-sm mb-4">Usu√°rio: <span id="user-id-display" class="font-mono text-gray-600">N/A</span></p>

        <!-- Sele√ß√£o do Modelo -->
        <div class="flex flex-col gap-2">
            <label for="model-select" class="text-lg font-semibold text-gray-700">Selecione o Modelo:</label>
            <select id="model-select" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-gray-800 shadow-sm">
                <!-- Os modelos ser√£o preenchidos dinamicamente pelo JavaScript -->
                <option value="" disabled selected>Carregando modelos...</option>
            </select>
        </div>

        <!-- √Årea de Mensagens do Chat -->
        <div id="messages-area" class="p-4 bg-gray-100 border border-gray-200 rounded-lg min-h-[300px] max-h-[500px] overflow-y-auto flex flex-col gap-3 shadow-inner">
            <!-- Mensagens do hist√≥rico ser√£o carregadas aqui -->
        </div>

        <!-- Entrada do Usu√°rio -->
        <div class="flex flex-col gap-2">
            <label for="prompt-input" class="text-lg font-semibold text-gray-700">Seu Prompt:</label>
            <textarea id="prompt-input" rows="3" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-gray-800 resize-y shadow-sm" placeholder="Digite sua pergunta ou comando aqui..."></textarea>
        </div>

        <!-- Bot√£o de A√ß√£o -->
        <button id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
            Enviar Prompt
        </button>
    </div>

    <!-- Caixa de Mensagem para alertas -->
    <div id="message-box" class="message-box"></div>

    <!-- Sobreposi√ß√£o de Carregamento -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Biblioteca Puter.js -->
    <script src="https://js.puter.com/v2/"></script>
    <script>
        // Log para verificar se a biblioteca Puter foi carregada
        // Isso deve ser vis√≠vel no console ANTES do script type="module"
        console.log("CHAT APP: >>> Verifica√ß√£o inicial do Puter SDK. typeof puter:", typeof puter);
        // puter.ai e puter.ai.chat podem n√£o estar imediatamente dispon√≠veis ap√≥s o carregamento ass√≠ncrono do script Puter.js
        // mas este log inicial nos ajuda a ver se o 'puter' base existe.
    </script>
    <!-- Bibliotecas Firebase -->
    <script type="module">
        // Importa as fun√ß√µes necess√°rias dos SDKs Firebase (vers√£o 12.1.0)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // APP_ID FIXO - AGORA COM O VALOR DO SEU NOVO FIREBASE APP_ID
        const appId = "1:1055585794088:web:0c7eab96a4e696cd6f9d1d"; 

        const firebaseConfig = {
            apiKey: "AIzaSyCov5xP4aFRo3QPFCxCRQGN7X59dR9ZLF4", // Confirme se esta chave est√° correta no seu Firebase
            authDomain: "isiskd.firebaseapp.com",
            projectId: "isiskd",
            storageBucket: "isiskd.firebasestorage.app",
            messagingSenderId: "1055585794088",
            appId: "1:1055585794088:web:0c7eab96a4e696cd6f9d1d",
            measurementId: "G-5S8S16K6KF"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let isAuthReady = false;
        let keyCheckInterval = null; // Para armazenar o ID do intervalo de verifica√ß√£o da chave
        let chatHistory = []; // Array para armazenar o hist√≥rico de chat

        // Elementos DOM
        const loginOverlay = document.getElementById('login-overlay');
        const accessKeyInput = document.getElementById('access-key-input');
        const loginButton = document.getElementById('login-button');
        const loginErrorMessage = document.getElementById('login-error-message');
        const chatContainer = document.getElementById('chat-container');
        const userIdDisplay = document.getElementById('user-id-display');
        const modelSelect = document.getElementById('model-select');
        const messagesArea = document.getElementById('messages-area'); // √Årea para exibir mensagens
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');

        // Fun√ß√£o para exibir caixa de mensagem personalizada
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = 'message-box show'; // Reseta classes e mostra
            if (type === 'error') {
                messageBox.style.backgroundColor = '#dc2626'; // Vermelho
            } else if (type === 'success') {
                messageBox.style.backgroundColor = '#16a34a'; // Verde
            } else {
                messageBox.style.backgroundColor = '#333'; // Cinza escuro padr√£o
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // Fun√ß√£o para mostrar/esconder sobreposi√ß√£o de carregamento
        function toggleLoading(show) {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (show) {
                loadingOverlay.classList.add('show');
            } else {
                loadingOverlay.classList.remove('show');
            }
        }

        // Fun√ß√£o para renderizar as mensagens no DOM
        function renderMessages() {
            messagesArea.innerHTML = ''; // Limpa a √°rea de mensagens
            chatHistory.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message');
                if (msg.role === 'user') {
                    messageDiv.classList.add('user-message');
                    messageDiv.textContent = `Voc√™: ${msg.text}`;
                } else if (msg.role === 'ai') {
                    messageDiv.classList.add('ai-message');
                    messageDiv.textContent = `IA: ${msg.text}`;
                }
                messagesArea.appendChild(messageDiv);
            });
            messagesArea.scrollTop = messagesArea.scrollHeight; // Rola para o final
        }

        // Fun√ß√£o para salvar o hist√≥rico de chat no Firestore
        async function saveChatHistory() {
            if (!userId) {
                console.warn("CHAT APP: N√£o √© poss√≠vel salvar o hist√≥rico: userId n√£o definido.");
                return;
            }
            const chatHistoryDocRef = doc(db, `/artifacts/${appId}/users/${userId}/userState`, 'chatHistoryDoc');
            try {
                // Salva o hist√≥rico completo como uma string JSON para evitar problemas com tipos de dados complexos
                await setDoc(chatHistoryDocRef, { history: JSON.stringify(chatHistory) }, { merge: true });
                console.log("CHAT APP: Hist√≥rico de chat salvo com sucesso.");
            } catch (error) {
                console.error("CHAT APP: Erro ao salvar hist√≥rico de chat:", error);
                showMessage("Erro ao salvar o hist√≥rico de chat.", 'error');
            }
        }

        // Fun√ß√£o para carregar o hist√≥rico de chat do Firestore
        function loadChatHistory() {
            if (!userId) {
                console.warn("CHAT APP: N√£o √© poss√≠vel carregar o hist√≥rico: userId n√£o definido.");
                return;
            }
            const chatHistoryDocRef = doc(db, `/artifacts/${appId}/users/${userId}/userState`, 'chatHistoryDoc');

            // Usa onSnapshot para escutar em tempo real as mudan√ßas no documento
            onSnapshot(chatHistoryDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.history) {
                        try {
                            // Parse a string JSON de volta para um array
                            chatHistory = JSON.parse(data.history);
                            console.log("CHAT APP: Hist√≥rico de chat carregado:", chatHistory);
                            renderMessages(); // Renderiza as mensagens carregadas
                        } catch (e) {
                            console.error("CHAT APP: Erro ao fazer parse do hist√≥rico de chat:", e);
                            chatHistory = []; // Reseta se houver erro de parse
                        }
                    } else {
                        chatHistory = []; // Inicia vazio se n√£o houver hist√≥rico
                    }
                } else {
                    chatHistory = []; // Inicia vazio se o documento n√£o existir
                }
                renderMessages(); // Garante que a √°rea de mensagens esteja atualizada
            }, (error) => {
                console.error("CHAT APP: Erro ao escutar o hist√≥rico de chat:", error);
                showMessage("Erro ao carregar o hist√≥rico de chat.", 'error');
                chatHistory = []; // Reseta em caso de erro
                renderMessages();
            });
        }


        // Autentica com Firebase
        onAuthStateChanged(auth, async (user) => {
            console.log("CHAT APP: onAuthStateChanged acionado. User:", user ? user.uid : 'null');
            if (!user) {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("CHAT APP: Firebase: Login com token personalizado.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("CHAT APP: Firebase: Login an√¥nimo.");
                    }
                } catch (error) {
                    console.error("CHAT APP: Firebase Auth Error:", error);
                    showMessage(`Erro de autentica√ß√£o Firebase: ${error.message}`, 'error');
                }
            }
            userId = auth.currentUser?.uid || crypto.randomUUID();
            userIdDisplay.textContent = userId.substring(0, 8) + '...';
            isAuthReady = true;
            console.log("CHAT APP: Firebase Auth Pronto. UID do Usu√°rio Atual:", auth.currentUser?.uid);
            console.log("CHAT APP: App ID em uso (FIXO):", appId);
            
            if (isAuthReady) {
                loadStaticModels();
                loadChatHistory(); 
            }
        });

        // LISTA DE MODELOS FILTRADA PARA AS OP√á√ïES FORNECIDAS
        const allAvailableModels = [
            "openrouter:amazon/nova-lite-v1",
            "openrouter:amazon/nova-micro-v1",
            "openrouter:amazon/nova-pro-v1",
            "openrouter:anthracite-org/magnum-v2-72b",
            "openrouter:anthracite-org/magnum-v4-72b",
            "openrouter:anthropic/claude-2",
            "openrouter:anthropic/claude-2.0",
            "openrouter:anthropic/claude-2.0:beta",
            "openrouter:anthropic/claude-2.1",
            "openrouter:anthropic/claude-2.1:beta",
            "openrouter:anthropic/claude-2:beta",
            "openrouter:anthropic/claude-3-haiku",
            "openrouter:anthropic/claude-3-haiku:beta",
            "openrouter:anthropic/claude-3-opus",
            "openrouter:anthropic/claude-3-opus:beta",
            "openrouter:anthropic/claude-3-sonnet",
            "openrouter:anthropic/claude-3-sonnet:beta",
            "openrouter:anthropic/claude-3.5-haiku",
            "openrouter:anthropic/claude-3.5-haiku-20241022",
            "openrouter:anthropic/claude-3.5-haiku-20241022:beta",
            "openrouter:anthropic/claude-3.5-haiku:beta",
            "openrouter:anthropic/claude-3.5-sonnet",
            "openrouter:anthropic/claude-3.5-sonnet-20240620",
            "openrouter:anthropic/claude-3.5-sonnet-20240620:beta",
            "openrouter:anthropic/claude-3.5-sonnet:beta",
            "openrouter:anthropic/claude-3.7-sonnet",
            "openrouter:anthropic/claude-3.7-sonnet:beta",
            "openrouter:anthropic/claude-3.7-sonnet:thinking",
            "openrouter:anthropic/claude-opus-4",
            "openrouter:anthropic/claude-sonnet-4",
            "openrouter:arcee-ai/arcee-blitz",
            "openrouter:arcee-ai/caller-large",
            "openrouter:arcee-ai/coder-large",
            "openrouter:arcee-ai/maestro-reasoning",
            "openrouter:arcee-ai/spotlight",
            "openrouter:arcee-ai/virtuoso-large",
            "openrouter:arcee-ai/virtuoso-medium-v2",
            "openrouter:arliai/qwq-32b-arliai-rpr-v1:free",
            "openrouter:baidu/ernie-4.5-300b-a47b",
            "openrouter:cognitivecomputations/dolphin-mixtral-8x22b",
            "openrouter:cognitivecomputations/dolphin3.0-mistral-24b:free",
            "openrouter:cognitivecomputations/dolphin3.0-r1-mistral-24b:free",
            "openrouter:cohere/command",
            "openrouter:cohere/command-a",
            "openrouter:cohere/command-r",
            "openrouter:cohere/command-r-03-2024",
            "openrouter:cohere/command-r-08-2024",
            "openrouter:cohere/command-r-plus",
            "openrouter:cohere/command-r-plus-04-2024",
            "openrouter:cohere/command-r-plus-08-2024",
            "openrouter:cohere/command-r7b-12-2024",
            "openrouter:deepseek/deepseek-chat",
            "openrouter:deepseek/deepseek-chat-v3-0324",
            "openrouter:deepseek/deepseek-chat-v3-0324:free",
            "openrouter:deepseek/deepseek-chat:free",
            "openrouter:deepseek/deepseek-prover-v2",
            "openrouter:deepseek/deepseek-r1",
            "openrouter:deepseek/deepseek-r1-0528",
            "openrouter:deepseek/deepseek-r1-0528-qwen3-8b",
            "openrouter:deepseek/deepseek-r1-0528-qwen3-8b:free",
            "openrouter:deepseek/deepseek-r1-0528:free",
            "openrouter:deepseek/deepseek-r1-distill-llama-70b",
            "openrouter:deepseek/deepseek-r1-distill-llama-70b:free",
            "openrouter:deepseek/deepseek-r1-distill-llama-8b",
            "openrouter:deepseek/deepseek-r1-distill-qwen-1.5b",
            "openrouter:deepseek/deepseek-r1-distill-qwen-14b",
            "openrouter:deepseek/deepseek-r1-distill-qwen-14b:free",
            "openrouter:deepseek/deepseek-r1-distill-qwen-32b",
            "openrouter:deepseek/deepseek-r1-distill-qwen-7b",
            "openrouter:deepseek/deepseek-r1:free",
            "openrouter:deepseek/deepseek-v3-base:free",
            "openrouter:eleutherai/llemma_7b",
            "openrouter:eva-unit-01/eva-llama-3.33-70b",
            "openrouter:eva-unit-01/eva-qwen-2.5-72b",
            "openrouter:featherless/qwerky-72b:free",
            "openrouter:google/gemini-2.0-flash-001",
            "openrouter:google/gemini-2.0-flash-exp:free",
            "openrouter:google/gemini-2.0-flash-lite-001",
            "openrouter:google/gemini-2.5-flash",
            "openrouter:google/gemini-2.5-flash-lite-preview-06-17",
            "openrouter:google/gemini-2.5-flash-preview",
            "openrouter:google/gemini-2.5-flash-preview-05-20",
            "openrouter:google/gemini-2.5-flash-preview-05-20:thinking",
            "openrouter:google/gemini-2.5-flash-preview:thinking",
            "openrouter:google/gemini-2.5-pro",
            "openrouter:google/gemini-2.5-pro-exp-03-25",
            "openrouter:google/gemini-2.5-pro-preview",
            "openrouter:google/gemini-2.5-pro-preview-05-06",
            "openrouter:google/gemini-flash-1.5",
            "openrouter:google/gemini-flash-1.5-8b",
            "openrouter:google/gemini-pro-1.5",
            "openrouter:google/gemma-2-27b-it",
            "openrouter:google/gemma-2-9b-it",
            "openrouter:google/gemma-2-9b-it:free",
            "openrouter:google/gemma-3-12b-it",
            "openrouter:google/gemma-3-12b-it:free",
            "openrouter:google/gemma-3-27b-it",
            "openrouter:google/gemma-3-27b-it:free",
            "openrouter:google/gemma-3-4b-it",
            "openrouter:google/gemma-3-4b-it:free",
            "openrouter:google/gemma-3n-e4b-it",
            "openrouter:google/gemma-3n-e4b-it:free",
            "openrouter:gryphe/mythomax-l2-13b",
            "openrouter:inception/mercury",
            "openrouter:inception/mercury-coder",
            "openrouter:infermatic/mn-inferor-12b",
            "openrouter:inflection/inflection-3-pi",
            "openrouter:inflection/inflection-3-productivity",
            "openrouter:liquid/lfm-3b",
            "openrouter:liquid/lfm-40b",
            "openrouter:liquid/lfm-7b",
            "openrouter:mancer/weaver",
            "openrouter:meta-llama/llama-3-70b-instruct",
            "openrouter:meta-llama/llama-3-8b-instruct",
            "openrouter:meta-llama/llama-3.1-405b",
            "openrouter:meta-llama/llama-3.1-405b-instruct",
            "openrouter:meta-llama/llama-3.1-70b-instruct",
            "openrouter:meta-llama/llama-3.1-8b-instruct",
            "openrouter:meta-llama/llama-3.2-11b-vision-instruct",
            "openrouter:meta-llama/llama-3.2-11b-vision-instruct:free",
            "openrouter:meta-llama/llama-3.2-1b-instruct",
            "openrouter:meta-llama/llama-3.2-3b-instruct",
            "openrouter:meta-llama/llama-3.2-90b-vision-instruct",
            "openrouter:meta-llama/llama-3.3-70b-instruct",
            "openrouter:meta-llama/llama-3.3-70b-instruct:free",
            "openrouter:meta-llama/llama-4-maverick",
            "openrouter:meta-llama/llama-4-maverick:free",
            "openrouter:meta-llama/llama-4-scout",
            "openrouter:meta-llama/llama-4-scout:free",
            "openrouter:meta-llama/llama-guard-2-8b",
            "openrouter:meta-llama/llama-guard-3-8b",
            "openrouter:meta-llama/llama-guard-4-12b",
            "openrouter:microsoft/mai-ds-r1:free",
            "openrouter:microsoft/phi-3-medium-128k-instruct",
            "openrouter:microsoft/phi-3-mini-128k-instruct",
            "openrouter:microsoft/phi-3.5-mini-128k-instruct",
            "openrouter:microsoft/phi-4",
            "openrouter:microsoft/phi-4-multimodal-instruct",
            "openrouter:microsoft/phi-4-reasoning-plus",
            "openrouter:microsoft/wizardlm-2-8x22b",
            "openrouter:minimax/minimax-01",
            "openrouter:minimax/minimax-m1",
            "openrouter:mistralai/codestral-2501",
            "openrouter:mistralai/devstral-small",
            "openrouter:mistralai/devstral-small:free",
            "openrouter:mistralai/magistral-medium-2506",
            "openrouter:mistralai/magistral-medium-2506:thinking",
            "openrouter:mistralai/magistral-small-2506",
            "openrouter:mistralai/ministral-3b",
            "openrouter:mistralai/ministral-8b",
            "openrouter:mistralai/mistral-7b-instruct",
            "openrouter:mistralai/mistral-7b-instruct-v0.1",
            "openrouter:mistralai/mistral-7b-instruct-v0.2",
            "openrouter:mistralai/mistral-7b-instruct-v0.3",
            "openrouter:mistralai/mistral-7b-instruct:free",
            "openrouter:mistralai/mistral-large",
            "openrouter:mistralai/mistral-large-2407",
            "openrouter:mistralai/mistral-large-2411",
            "openrouter:mistralai/mistral-medium-3",
            "openrouter:mistralai/mistral-nemo",
            "openrouter:mistralai/mistral-nemo:free",
            "openrouter:mistralai/mistral-saba",
            "openrouter:mistralai/mistral-small",
            "openrouter:mistralai/mistral-small-24b-instruct-2501",
            "openrouter:mistralai/mistral-small-24b-instruct-2501:free",
            "openrouter:mistralai/mistral-small-3.1-24b-instruct",
            "openrouter:mistralai/mistral-small-3.1-24b-instruct:free",
            "openrouter:mistralai/mistral-small-3.2-24b-instruct",
            "openrouter:mistralai/mistral-small-3.2-24b-instruct:free",
            "openrouter:mistralai/mistral-tiny",
            "openrouter:mistralai/mixtral-8x22b-instruct",
            "openrouter:mistralai/mixtral-8x7b-instruct",
            "openrouter:mistralai/pixtral-12b",
            "openrouter:mistralai/pixtral-large-2411",
            "openrouter:moonshotai/kimi-dev-72b:free",
            "openrouter:moonshotai/kimi-vl-a3b-thinking:free",
            "openrouter:morph/morph-v2",
            "openrouter:morph/morph-v3-fast",
            "openrouter:morph/morph-v3-large",
            "openrouter:neversleep/llama-3-lumimaid-70b",
            "openrouter:neversleep/llama-3-lumimaid-8b",
            "openrouter:neversleep/llama-3.1-lumimaid-8b",
            "openrouter:neversleep/noromaid-20b",
            "openrouter:nothingiisreal/mn-celeste-12b",
            "openrouter:nousresearch/deephermes-3-llama-3-8b-preview:free",
            "openrouter:nousresearch/hermes-2-pro-llama-3-8b",
            "openrouter:nousresearch/hermes-3-llama-3.1-405b",
            "openrouter:nousresearch/hermes-3-llama-3.1-70b",
            "openrouter:nousresearch/nous-hermes-2-mixtral-8x7b-dpo",
            "openrouter:nvidia/llama-3.1-nemotron-70b-instruct",
            "openrouter:nvidia/llama-3.1-nemotron-ultra-253b-v1",
            "openrouter:nvidia/llama-3.1-nemotron-ultra-253b-v1:free",
            "openrouter:nvidia/llama-3.3-nemotron-super-49b-v1",
            "openrouter:nvidia/llama-3.3-nemotron-super-49b-v1:free",
            "openrouter:openai/chatgpt-4o-latest",
            "openrouter:openai/codex-mini",
            "openrouter:openai/gpt-3.5-turbo-0613",
            "openrouter:openai/gpt-3.5-turbo-16k",
            "openrouter:openai/gpt-3.5-turbo-instruct",
            "openrouter:openai/gpt-4",
            "openrouter:openai/gpt-4-0314",
            "openrouter:openai/gpt-4-1106-preview",
            "openrouter:openai/gpt-4-turbo",
            "openrouter:openai/gpt-4-turbo-preview",
            "openrouter:openai/gpt-4.1",
            "openrouter:openai/gpt-4.1-mini",
            "openrouter:openai/gpt-4.1-nano",
            "openrouter:openai/gpt-4.5-preview",
            "openrouter:openai/gpt-4o",
            "openrouter:openai/gpt-4o-2024-05-13",
            "openrouter:openai/gpt-4o-2024-08-06",
            "openrouter:openai/gpt-4o-2024-11-20",
            "openrouter:openai/gpt-4o-mini",
            "openrouter:openai/gpt-4o-mini-2024-07-18",
            "openrouter:openai/gpt-4o-mini-search-preview",
            "openrouter:openai/gpt-4o-search-preview",
            "openrouter:openai/gpt-4o:extended",
            "openrouter:openai/o1",
            "openrouter:openai/o1-mini",
            "openrouter:openai/o1-mini-2024-09-12",
            "openrouter:openai/o1-preview",
            "openrouter:openai/o1-preview-2024-09-12",
            "openrouter:openai/o1-pro",
            "openrouter:openai/o3",
            "openrouter:openai/o3-mini",
            "openrouter:openai/o3-mini-high",
            "openrouter:openai/o3-pro",
            "openrouter:openai/o4-mini",
            "openrouter:openai/o4-mini-high",
            "openrouter:opengvlab/internvl3-14b",
            "openrouter:openrouter/auto",
            "openrouter:openrouter/cypher-alpha:free",
            "openrouter:perplexity/r1-1776",
            "openrouter:perplexity/sonar",
            "openrouter:perplexity/sonar-deep-research",
            "openrouter:perplexity/sonar-pro",
            "openrouter:perplexity/sonar-reasoning",
            "openrouter:perplexity/sonar-reasoning-pro",
            "openrouter:pygmalionai/mythalion-13b",
            "openrouter:qwen/qwen-2-72b-instruct",
            "openrouter:qwen/qwen-2.5-72b-instruct",
            "openrouter:qwen/qwen-2.5-72b-instruct:free",
            "openrouter:qwen/qwen-2.5-7b-instruct",
            "openrouter:qwen/qwen-2.5-coder-32b-instruct",
            "openrouter:qwen/qwen-2.5-coder-32b-instruct:free",
            "openrouter:qwen/qwen-2.5-vl-7b-instruct",
            "openrouter:qwen/qwen-max",
            "openrouter:qwen/qwen-plus",
            "openrouter:qwen/qwen-turbo",
            "openrouter:qwen/qwen-vl-max",
            "openrouter:qwen/qwen-vl-plus",
            "openrouter:qwen/qwen2.5-vl-32b-instruct",
            "openrouter:qwen/qwen2.5-vl-32b-instruct:free",
            "openrouter:qwen/qwen2.5-vl-72b-instruct",
            "openrouter:qwen/qwen2.5-vl-72b-instruct:free",
            "openrouter:qwen/qwen3-14b",
            "openrouter:qwen/qwen3-14b:free",
            "openrouter:qwen/qwen3-235b-a22b",
            "openrouter:qwen/qwen3-235b-a22b:free",
            "openrouter:qwen/qwen3-30b-a3b",
            "openrouter:qwen/qwen3-30b-a3b:free",
            "openrouter:qwen/qwen3-32b",
            "openrouter:qwen/qwen3-32b:free",
            "openrouter:qwen/qwen3-8b",
            "openrouter:qwen/qwen3-8b:free",
            "openrouter:qwen/qwen3-coder",
            "openrouter:qwq-32b",
            "openrouter:qwq-32b-preview",
            "openrouter:qwq-32b:free",
            "openrouter:sao10k/l3-euryale-70b",
            "openrouter:sao10k/l3-lunaris-8b",
            "openrouter:sao10k/l3.1-euryale-70b",
            "openrouter:sao10k/l3.3-euryale-70b",
            "openrouter:scb10x/llama3.1-typhoon2-70b-instruct",
            "openrouter:shisa-ai/shisa-v2-llama3.3-70b",
            "openrouter:shisa-ai/shisa-v2-llama3.3-70b:free",
            "openrouter:sophosympatheia/midnight-rose-70b",
            "openrouter:switchpoint/router",
            "openrouter:tencent/hunyuan-a13b-instruct",
            "openrouter:tencent/hunyuan-a13b-instruct:free",
            "openrouter:thedrummer/anubis-70b-v1.1",
            "openrouter:thedrummer/anubis-pro-105b-v1",
            "openrouter:thedrummer/rocinante-12b",
            "openrouter:thedrummer/skyfall-36b-v2",
            "openrouter:thedrummer/unslopnemo-12b",
            "openrouter:thedrummer/valkyrie-49b-v1",
            "openrouter:thudm/glm-4-32b",
            "openrouter:thudm/glm-4.1v-9b-thinking",
            "openrouter:thudm/glm-z1-32b",
            "openrouter:thudm/glm-z1-32b:free",
            "openrouter:tngtech/deepseek-r1t-chimera",
            "openrouter:tngtech/deepseek-r1t-chimera:free",
            "openrouter:tngtech/deepseek-r1t2-chimera:free",
            "openrouter:undi95/remm-slerp-l2-13b",
            "openrouter:x-ai/grok-2-1212",
            "openrouter:x-ai/grok-2-vision-1212",
            "openrouter:x-ai/grok-3",
            "openrouter:x-ai/grok-3-beta",
            "openrouter:x-ai/grok-3-mini",
            "openrouter:x-ai/grok-3-mini-beta",
            "openrouter:x-ai/grok-4",
            "openrouter:x-ai/grok-vision-beta",
            "openrouter:zai-org/glm-4.5",
            "openrouter:zai-org/glm-4.5-air",
            "openrouter:zai-org/glm-4.5-air:free",
            "openrouter:zai-org/glm-4.5v",
            "openrouter:z-ai/glm-4-32b"
        ];

        // Fun√ß√£o para carregar e preencher os modelos da lista est√°tica
        function loadStaticModels() {
            console.log("CHAT APP: Come√ßando a carregar modelos est√°ticos...");
            modelSelect.innerHTML = '<option value="" disabled selected>Carregando modelos...</option>'; // Placeholder
            toggleLoading(true); // Exibe o spinner de carregamento

            if (allAvailableModels.length > 0) {
                modelSelect.innerHTML = ''; // Limpa o placeholder
                // Ordena os modelos alfabeticamente para melhor visualiza√ß√£o
                const sortedModels = [...allAvailableModels].sort(); 
                sortedModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
                console.log("CHAT APP: Modelos preenchidos com sucesso. Total:", sortedModels.length);
            } else {
                modelSelect.innerHTML = '<option value="" disabled selected>Nenhum modelo encontrado ou compat√≠vel.</option>';
                showMessage("Nenhum modelo compat√≠vel encontrado da lista fornecida.", 'info');
                console.warn("CHAT APP: Nenhum modelo compat√≠vel encontrado da lista.");
            }
            toggleLoading(false); // Esconde o spinner de carregamento no final
        }


        // Fun√ß√£o para verificar a expira√ß√£o da chave periodicamente
        async function checkKeyExpiration(expiresAtMs) {
            if (keyCheckInterval) {
                clearInterval(keyCheckInterval); // Limpa qualquer intervalo anterior
            }
            keyCheckInterval = setInterval(async () => {
                const currentTime = Date.now();
                if (currentTime >= expiresAtMs) {
                    // Chave expirada, for√ßa logout
                    clearInterval(keyCheckInterval);
                    loginOverlay.style.opacity = '1'; // Garante que esteja vis√≠vel
                    loginOverlay.classList.remove('hidden');
                    chatContainer.classList.add('hidden');
                    showMessage("Sua chave de acesso expirou. Por favor, fa√ßa login novamente.", 'error');
                    console.log("CHAT APP: Chave expirou. Usu√°rio desconectado.");
                    // Limpar hist√≥rico local e redefinir estado
                    chatHistory = [];
                    renderMessages();
                    userIdDisplay.textContent = 'N/A';
                    // Opcional: desconecta o usu√°rio Firebase (isso ir√° acionar onAuthStateChanged novamente)
                    // await auth.signOut();
                } else {
                    // console.log(`CHAT APP: Chave ativa. Tempo restante: ${(expiresAtMs - currentTime) / 1000} segundos.`);
                }
            }, 5000); // Verifica a cada 5 segundos
        }

        // Listener de Eventos para o Bot√£o de Login
        loginButton.addEventListener('click', async () => {
            if (!isAuthReady) {
                showMessage("Autenticando com Firebase, por favor, aguarde...", 'info');
                console.log("CHAT APP: Tentativa de Login: Firebase n√£o pronto.");
                return;
            }

            const enteredKey = accessKeyInput.value.trim();
            if (!enteredKey) {
                loginErrorMessage.textContent = "Por favor, insira uma chave de acesso.";
                loginErrorMessage.classList.remove('hidden');
                console.log("CHAT APP: Tentativa de Login: Nenhuma chave inserida.");
                return;
            }
            loginErrorMessage.classList.add('hidden'); // Esconde erro anterior

            toggleLoading(true);

            try {
                // Consulta a cole√ß√£o de chaves p√∫blicas usando o appId FIXO
                const keysCollectionRef = collection(db, `/artifacts/${appId}/public/data/accessKeys`);
                console.log(`CHAT APP: Consultando Firestore collection: /artifacts/${appId}/public/data/accessKeys para a chave: ${enteredKey}`);
                const q = query(keysCollectionRef, where("key", "==", enteredKey));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    loginErrorMessage.textContent = "Chave de acesso inv√°lida.";
                    loginErrorMessage.classList.remove('hidden');
                    console.log("CHAT APP: Chave N√ÉO encontrada no Firestore (querySnapshot.empty √© true).");
                } else {
                    let keyIsValid = false;
                    let expiresAtTimestamp = 0;
                    querySnapshot.forEach((doc) => {
                        const keyData = doc.data();
                        const currentTime = Date.now();
                        console.log("CHAT APP: Dados da chave encontrados:", keyData);

                        let expiresAtMs;
                        // Verifica se expiresAt √© um objeto Timestamp do Firestore ou um n√∫mero
                        if (keyData.expiresAt && typeof keyData.expiresAt.toMillis === 'function') {
                            expiresAtMs = keyData.expiresAt.toMillis();
                        } else if (typeof keyData.expiresAt === 'number') {
                            expiresAtMs = keyData.expiresAt;
                        } else {
                            // Se expiresAt n√£o for um Timestamp ou n√∫mero, assumimos 0 para seguran√ßa (expirado)
                            expiresAtMs = 0; 
                        }
                        
                        console.log("CHAT APP: Status da chave:", keyData.status);
                        console.log("CHAT APP: Hora atual (MS):", currentTime);
                        console.log("CHAT APP: Expira em (MS):", expiresAtMs);
                        console.log("CHAT APP: Condi√ß√£o 1 (status === 'active'):", keyData.status === 'active');
                        console.log("CHAT APP: Condi√ß√£o 2 (expiresAtMs > currentTime):", expiresAtMs > currentTime);

                        if (keyData.status === 'active' && expiresAtMs > currentTime) {
                            keyIsValid = true;
                            expiresAtTimestamp = expiresAtMs; // Salva o timestamp de expira√ß√£o
                            console.log("CHAT APP: Chave √© v√°lida! Todas as condi√ß√µes TRUE.");
                        } else {
                            console.log("CHAT APP: Chave √© INV√ÅLIDA. Verifique as condi√ß√µes acima.");
                        }
                    });

                    if (keyIsValid) {
                        // Se a chave for v√°lida, esconde a sobreposi√ß√£o de login
                        loginOverlay.style.opacity = '0';
                        setTimeout(() => {
                            loginOverlay.classList.add('hidden');
                            chatContainer.classList.remove('hidden');
                        }, 300); // D√° tempo para a transi√ß√£o
                        showMessage("Login bem-sucedido!", 'success');
                        // Inicia a verifica√ß√£o de expira√ß√£o da chave
                        checkKeyExpiration(expiresAtTimestamp);

                    } else {
                        loginErrorMessage.textContent = "Chave de acesso expirada ou inativa.";
                        loginErrorMessage.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error("CHAT APP: Erro de Valida√ß√£o de Chave Firebase:", error);
                loginErrorMessage.textContent = "Erro ao verificar a chave. Tente novamente.";
                loginErrorMessage.classList.remove('hidden');
            } finally {
                toggleLoading(false);
            }
        });

        // Listener de Eventos para enviar o prompt (somente ap√≥s o login)
        sendButton.addEventListener('click', async () => {
            const selectedModel = modelSelect.value;
            const promptInputValue = promptInput.value.trim();

            if (!promptInputValue) {
                showMessage("Por favor, digite um prompt para a IA.", 'error');
                return;
            }
            
            // Log detalhado sobre o objeto puter antes de usar
            console.log("CHAT APP: >>> Verificando objeto Puter antes da chamada AI:");
            console.log("CHAT APP: typeof puter:", typeof puter);
            console.log("CHAT APP: puter.ai:", typeof puter !== 'undefined' ? puter.ai : 'undefined');
            console.log("CHAT APP: puter.ai.chat:", (typeof puter !== 'undefined' && puter.ai) ? puter.ai.chat : 'undefined');


            // Verifica se puter e puter.ai.chat est√£o dispon√≠veis
            if (typeof puter === 'undefined' || !puter.ai || typeof puter.ai.chat !== 'function') {
                showMessage("Puter SDK n√£o carregado ou n√£o funcional. Verifique a conex√£o e o console.", 'error');
                console.error("CHAT APP: Erro: Puter SDK n√£o est√° dispon√≠vel para chat. Verifique se o script 'https://js.puter.com/v2/' foi carregado e se o objeto 'puter' foi inicializado corretamente.");
                return;
            }

            toggleLoading(true); // Mostra indicador de carregamento

            // Adiciona a mensagem do usu√°rio ao hist√≥rico e renderiza
            chatHistory.push({ role: 'user', text: promptInputValue });
            renderMessages();
            saveChatHistory(); // Salva o hist√≥rico atualizado

            promptInput.value = ''; // Limpa a √°rea de entrada

            try {
                console.log(`CHAT APP: Chamando puter.ai.chat com modelo: ${selectedModel}, Prompt: "${promptInputValue.substring(0, 50)}..."`);
                const response = await puter.ai.chat(promptInputValue, {
                    model: selectedModel
                });
                console.log("CHAT APP: Resposta da Puter API recebida:", response);

                // Adiciona a resposta da IA ao hist√≥rico e renderiza
                chatHistory.push({ role: 'ai', text: response.message.content });
                renderMessages();
                saveChatHistory(); // Salva o hist√≥rico atualizado

            } catch (error) {
                console.error("CHAT APP: Erro direto no Puter API call:", error);
                let errorMessage = "Erro desconhecido ao obter resposta da IA.";
                if (error instanceof Error) {
                    errorMessage = error.message;
                    // Se for um objeto Error, tente pegar o stack trace tamb√©m
                    console.error("CHAT APP: Stack trace do erro:", error.stack);
                } else if (typeof error === 'object' && error !== null) {
                    try {
                        // Tenta stringify o erro para obter mais detalhes
                        errorMessage = JSON.stringify(error, Object.getOwnPropertyNames(error));
                    } catch (e) {
                        errorMessage = String(error); // √öltimo recurso
                    }
                } else {
                    errorMessage = String(error); // Converte para string se n√£o for um objeto
                }
                
                // Adiciona uma mensagem de erro ao hist√≥rico se falhar
                chatHistory.push({ role: 'ai', text: `Erro: N√£o foi poss√≠vel obter resposta da IA. Detalhes: ${errorMessage}` });
                renderMessages();
                showMessage("Erro ao obter resposta da IA. Verifique o console para mais detalhes.", 'error');
            } finally {
                toggleLoading(false); // Esconde indicador de carregamento
            }
        });
    </script>
</body>
</html>
