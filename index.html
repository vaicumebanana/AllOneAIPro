<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllOneAI Pro - Todos os Modelos de IA em Um Lugar</title>
    <style>
        :root {
            --primary: #6e48aa;
            --secondary: #9d50bb;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --success: #28a745;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
        }
        
        .chat-container {
            flex: 2;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 70vh;
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: var(--primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .ai-message {
            background-color: #f1f1f1;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .ai-message img {
            max-width: 100%;
            border-radius: 5px;
            margin-top: 10px;
        }

        .ai-message video {
            max-width: 100%;
            border-radius: 5px;
            margin-top: 10px;
        }

        .ai-message .download-button {
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.3s;
            display: inline-block; /* Para o botão ficar ao lado, se houver texto */
            margin-left: 5px;
        }

        .ai-message .download-button:hover {
            background-color: #7a3a91;
        }

        .ai-message audio {
            width: 100%;
            margin-top: 10px;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Permite que os botões quebrem a linha em telas pequenas */
        }
        
        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border 0.3s;
        }
        
        #user-input:focus {
            border-color: var(--primary);
        }
        
        #send-button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 0 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        #send-button:hover {
            background-color: var(--secondary);
        }

        .command-hint {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            width: 100%;
            text-align: center;
        }

        .command-hint span {
            font-family: 'Courier New', Courier, monospace;
            background-color: #e0e0e0;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .sidebar {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            height: fit-content;
        }
        
        .model-selector {
            margin-bottom: 20px;
        }
        
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .model-info {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid var(--primary);
            margin-top: 10px;
        }
        
        .conversation-history {
            margin-top: 20px;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .history-item:hover {
            background-color: #f5f5f5;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 10px 0;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>AllOneAI Pro</h1>
            <p class="subtitle">Todos os modelos de IA em um único lugar</p>
        </div>
    </header>
    
    <div class="container">
        <div class="main-content">
            <div class="chat-container">
                <div class="chat-history" id="chat-history">
                    <div class="message ai-message">
                        Olá! Eu sou o AllOneAI Pro. Escolha um modelo no menu à direita e comece a conversar!
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Processando sua mensagem...</p>
                </div>
                
                <div class="input-area">
                    <input type="text" id="user-input" placeholder="Digite sua mensagem..." autocomplete="off">
                    <button id="send-button">Enviar</button>
                    <div class="command-hint">
                        Use <span>/imagem [descrição]</span> para gerar imagens, <span>/falar [texto]</span> para áudio, ou <span>/gerarvideo [descrição]</span> para criar um vídeo.
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="model-selector">
                    <h3>Selecione o Modelo</h3>
                    <select id="model-selector">
                        <option value="">-- Selecione um Modelo --</option>
                        </select>
                    <div class="model-info" id="model-info">
                        Selecione um modelo para ver sua descrição
                    </div>
                </div>
                
                <div class="conversation-history">
                    <h3>Histórico de Conversas</h3>
                    <div id="history-list">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://js.puter.com/v2/"></script>
    <script>
        // Objeto com todos os modelos e suas descrições
        const models = {
            // 01-ai
            "openrouter:01-ai/yi-large": {
                name: "Yi Large",
                description: "Modelo avançado da 01.AI com capacidade de processamento de linguagem natural em larga escala."
            },
            
            // Aetherwiing
            "openrouter:aetherwiing/mn-starcannon-12b": {
                name: "MN Starcannon 12B",
                description: "Modelo especializado em geração criativa de conteúdo e narrativas complexas."
            },
            
            // Agentica
            "openrouter:agentica-org/deepcoder-14b-preview:free": {
                name: "Deepcoder 14B",
                description: "Especializado em programação e geração de código, com suporte a múltiplas linguagens."
            },
            
            // AI21
            "openrouter:ai21/jamba-1.6-large": {
                name: "Jamba 1.6 Large",
                description: "Modelo versátil para diversas tarefas de processamento de linguagem natural."
            },
            "openrouter:ai21/jamba-1.6-mini": {
                name: "Jamba 1.6 Mini",
                description: "Versão compacta do Jamba, ideal para respostas rápidas e eficientes."
            },
            
            // Aion Labs
            "openrouter:aion-labs/aion-1.0": {
                name: "Aion 1.0",
                description: "Modelo geral com foco em compreensão contextual avançada."
            },
            "openrouter:aion-labs/aion-1.0-mini": {
                name: "Aion 1.0 Mini",
                description: "Versão compacta do Aion 1.0 para tarefas mais simples."
            },
            "openrouter:aion-labs/aion-rp-llama-3.1-8b": {
                name: "Aion RP Llama 3.1 8B",
                description: "Modelo especializado em roleplay e narrativas interativas."
            },
            
            // Alfredpros
            "openrouter:alfredpros/codellama-7b-instruct-solidity": {
                name: "Codellama 7B Solidity",
                description: "Especializado em programação blockchain e contratos inteligentes em Solidity."
            },
            
            // Alpindale
            "openrouter:alpindale/goliath-120b": {
                name: "Goliath 120B",
                description: "Um dos maiores modelos disponíveis, com capacidade excepcional para tarefas complexas."
            },
            "openrouter:alpindale/magnum-72b": {
                name: "Magnum 72B",
                description: "Modelo poderoso para análise e geração de texto avançada."
            },
            
            // Amazon
            "openrouter:amazon/nova-lite-v1": {
                name: "Amazon Nova Lite",
                description: "Versão leve do modelo da Amazon para tarefas gerais."
            },
            "openrouter:amazon/nova-micro-v1": {
                name: "Amazon Nova Micro",
                description: "Modelo compacto da Amazon para respostas rápidas."
            },
            "openrouter:amazon/nova-pro-v1": {
                name: "Amazon Nova Pro",
                description: "Versão avançada do modelo da Amazon com maior capacidade."
            },
            
            // Anthropic (Claude)
            "openrouter:anthropic/claude-2": {
                name: "Claude 2",
                description: "Modelo geral da Anthropic com foco em segurança e alinhamento."
            },
            "openrouter:anthropic/claude-2.0": {
                name: "Claude 2.0",
                description: "Versão estável do Claude com melhorias na coerência."
            },
            "openrouter:anthropic/claude-2.1": {
                name: "Claude 2.1",
                description: "Versão aprimorada do Claude 2 com melhor compreensão contextual."
            },
            "openrouter:anthropic/claude-3-haiku": {
                name: "Claude 3 Haiku",
                description: "Modelo rápido e eficiente da série Claude 3 para respostas concisas."
            },
            "openrouter:anthropic/claude-3-opus": {
                name: "Claude 3 Opus",
                description: "O modelo mais avançado da série Claude 3 para tarefas complexas."
            },
            "openrouter:anthropic/claude-3-sonnet": {
                name: "Claude 3 Sonnet",
                description: "Modelo balanceado da série Claude 3 com ótimo custo-benefício."
            },
            "openrouter:anthropic/claude-3.5-haiku": {
                name: "Claude 3.5 Haiku",
                description: "Versão atualizada do Haiku com melhor desempenho e eficiência."
            },
            "openrouter:anthropic/claude-3.5-sonnet": {
                name: "Claude 3.5 Sonnet",
                description: "Versão aprimorada do Sonnet com maior capacidade de raciocínio."
            },
            
            // Arcee AI
            "openrouter:arcee-ai/arcee-blitz": {
                name: "Arcee Blitz",
                description: "Modelo rápido para respostas instantâneas e tarefas simples."
            },
            "openrouter:arcee-ai/coder-large": {
                name: "Arcee Coder Large",
                description: "Modelo especializado em programação e análise de código."
            },
            
            // Baidu
            "openrouter:baidu/ernie-4.5-300b-a47b": {
                name: "Ernie 4.5",
                description: "Modelo avançado da Baidu com foco em compreensão de linguagem chinesa e inglesa."
            },
            
            // Cognitive Computations
            "openrouter:cognitivecomputations/dolphin-mixtral-8x22b": {
                name: "Dolphin Mixtral 8x22B",
                description: "Modelo especializado em tarefas criativas e assistência geral."
            },
            
            // Cohere
            "openrouter:cohere/command-r": {
                name: "Cohere Command R",
                description: "Modelo avançado da Cohere para pesquisa e recuperação de informações."
            },
            "openrouter:cohere/command-r-plus": {
                name: "Cohere Command R+",
                description: "Versão premium do Command R com maior capacidade de raciocínio."
            },
            
            // Deepseek
            "openrouter:deepseek/deepseek-chat": {
                name: "Deepseek Chat",
                description: "Modelo geral para conversação e assistência em diversas tarefas."
            },
            "openrouter:deepseek/deepseek-prover-v2": {
                name: "Deepseek Prover",
                description: "Especializado em raciocínio lógico e provas matemáticas."
            },
            
            // Google
            "openrouter:google/gemini-2.0-flash-001": {
                name: "Gemini 2.0 Flash",
                description: "Modelo rápido da Google para respostas instantâneas."
            },
            "openrouter:google/gemini-2.5-pro": {
                name: "Gemini 2.5 Pro",
                description: "Versão avançada do Gemini com maior capacidade de compreensão."
            },
            "openrouter:google/gemma-2-27b-it": {
                name: "Gemma 2 27B",
                description: "Modelo de código aberto da Google para diversas aplicações."
            },
            
            // Meta (Llama)
            "openrouter:meta-llama/llama-3-70b-instruct": {
                name: "Llama 3 70B",
                description: "Um dos modelos mais avançados da série Llama 3 para instruções complexas."
            },
            "openrouter:meta-llama/llama-3-8b-instruct": {
                name: "Llama 3 8B",
                description: "Versão mais leve do Llama 3 ainda com bom desempenho."
            },
            "openrouter:meta-llama/llama-3.1-70b-instruct": {
                name: "Llama 3.1 70B",
                description: "Versão atualizada do Llama 3 com melhorias na compreensão."
            },
            
            // Microsoft
            "openrouter:microsoft/phi-3-medium-128k-instruct": {
                name: "Phi-3 Medium",
                description: "Modelo balanceado da Microsoft para diversas tarefas."
            },
            "openrouter:microsoft/phi-4": {
                name: "Phi-4",
                description: "Modelo avançado da Microsoft com grande capacidade de raciocínio."
            },
            
            // Mistral
            "openrouter:mistralai/mistral-7b-instruct": {
                name: "Mistral 7B",
                description: "Modelo eficiente para instruções e tarefas gerais."
            },
            "openrouter:mistralai/mistral-large": {
                name: "Mistral Large",
                description: "Modelo avançado da Mistral com excelente desempenho."
            },
            "openrouter:mistralai/mixtral-8x7b-instruct": {
                name: "Mixtral 8x7B",
                description: "Modelo de mistura de especialistas com ótimo custo-benefício."
            },
            
            // OpenAI
            "openrouter:openai/gpt-3.5-turbo-16k": {
                name: "GPT-3.5 Turbo",
                description: "Modelo rápido e eficiente da OpenAI para diversas tarefas."
            },
            "openrouter:openai/gpt-4": {
                name: "GPT-4",
                description: "Modelo avançado da OpenAI com maior capacidade de raciocínio."
            },
            "openrouter:openai/gpt-4-turbo": {
                name: "GPT-4 Turbo",
                description: "Versão otimizada do GPT-4 com melhor desempenho."
            },
            "openrouter:openai/gpt-4o": {
                name: "GPT-4o",
                description: "Modelo mais recente da OpenAI com multimodalidade e melhor desempenho."
            },
            
            // Outros modelos importantes
            "openrouter:openrouter/auto": {
                name: "Auto (OpenRouter)",
                description: "Permite que o OpenRouter selecione automaticamente o melhor modelo para sua tarefa."
            },
            "openrouter:perplexity/sonar-large": {
                name: "Sonar Large",
                description: "Modelo avançado da Perplexity para pesquisa e respostas precisas."
            },
            "openrouter:qwen/qwen-2-72b-instruct": {
                name: "Qwen 2 72B",
                description: "Modelo avançado da Alibaba para diversas tarefas de linguagem."
            }
        };

        // Variáveis globais
        let currentModel = "";
        let conversationHistory = [];
        let currentConversation = [];
        
        // --- API Keys (Para desenvolvimento/teste. Em produção, use um backend para chaves) ---
        // A chave API que você forneceu. MUITO CUIDADO ao usar chaves em frontend em produção.
        const COMETAPI_KEY = "sk-5bI4uGFfNfBlAll6UvRjhRtGuI1f6HVxxXs4sG51eugmMhB3";
        const COMETAPI_URL = "https://api.cometapi.com/v1/chat/completions";
        // --- Fim das API Keys ---
        
        // Inicialização do DOM
        document.addEventListener('DOMContentLoaded', function() {
            // Preencher o seletor de modelos
            const modelSelector = document.getElementById('model-selector');
            const modelInfo = document.getElementById('model-info');
            
            // Agrupar modelos por provedor
            const providers = {};
            for (const [id, data] of Object.entries(models)) {
                const provider = id.split(':')[1].split('/')[0];
                if (!providers[provider]) {
                    providers[provider] = [];
                }
                providers[provider].push({id, ...data});
            }
            
            // Adicionar modelos ao seletor
            for (const [provider, models] of Object.entries(providers)) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = provider;
                
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    optgroup.appendChild(option);
                });
                
                modelSelector.appendChild(optgroup);
            }
            
            // Event listener para seleção de modelo
            modelSelector.addEventListener('change', function() {
                currentModel = this.value;
                const modelData = models[currentModel];
                
                if (modelData) {
                    modelInfo.innerHTML = `<strong>${modelData.name}</strong><br>${modelData.description}`;
                    
                    // Adicionar mensagem inicial quando um modelo é selecionado
                    if (currentConversation.length === 0) {
                        addMessage(`Agora você está conversando com ${modelData.name}. Como posso ajudar?`, 'ai');
                    }
                } else {
                    modelInfo.textContent = "Selecione um modelo para ver sua descrição";
                }
            });
            
            // Event listener para enviar mensagem
            const sendButton = document.getElementById('send-button');
            const userInput = document.getElementById('user-input');
            
            sendButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Carregar histórico de conversas do localStorage
            loadConversationHistory();
        });
        
        // Função para enviar mensagem
        async function sendMessage() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();
            
            if (!message) return;
            // Removed currentModel check here to allow /gerarvideo without a selected chat model
            // If you want /gerarvideo to only work when a model is selected, uncomment below:
            // if (!currentModel && !message.toLowerCase().startsWith('/gerarvideo')) {
            //     alert("Por favor, selecione um modelo primeiro para chat ou use /gerarvideo.");
            //     return;
            // }
            
            // Adicionar mensagem do usuário ao chat
            addMessage(message, 'user');
            userInput.value = '';
            
            // Mostrar indicador de carregamento
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            // Adicionar mensagem ao histórico da conversa atual
            currentConversation.push({role: 'user', content: message});
            
            try {
                // Verificar se a mensagem é para gerar imagem
                if (message.toLowerCase().startsWith('/imagem')) {
                    const prompt = message.substring('/imagem'.length).trim();
                    if (prompt) {
                        const imageUrl = await puter.ai.txt2img(prompt);
                        addMessageWithDownload(imageUrl, 'ai', 'image');
                        currentConversation.push({role: 'assistant', content: `[Imagem gerada: ${prompt}]`, url: imageUrl, type: 'image'});
                    } else {
                        addMessage("Por favor, forneça um prompt para a imagem. Ex: /imagem um gato no espaço", 'ai');
                    }
                } 
                // Verificar se a mensagem é para text-to-speech
                else if (message.toLowerCase().startsWith('/falar')) {
                    const textToSpeak = message.substring('/falar'.length).trim();
                    if (textToSpeak) {
                        const audioBlob = await puter.ai.txt2speech(textToSpeak, 'pt'); // 'pt' para português
                        const audioUrl = URL.createObjectURL(audioBlob);
                        addMessageWithDownload(audioUrl, 'ai', 'audio', textToSpeak);
                        currentConversation.push({role: 'assistant', content: `[Áudio reproduzido: ${textToSpeak}]`, url: audioUrl, type: 'audio'});
                    } else {
                        addMessage("Por favor, forneça um texto para eu falar. Ex: /falar Olá, como você está?", 'ai');
                    }
                }
                // Verificar se a mensagem é para gerar vídeo com CometAPI
                else if (message.toLowerCase().startsWith('/gerarvideo')) {
                    const videoPrompt = message.substring('/gerarvideo'.length).trim();
                    if (videoPrompt) {
                        await generateVideoWithCometAPI(videoPrompt);
                    } else {
                        addMessage("Por favor, forneça um prompt para o vídeo. Ex: /gerarvideo um gato fofo em uma nuvem", 'ai');
                    }
                }
                // Se não for comando de mídia, enviar para o chat normal
                else {
                    if (!currentModel) {
                        addMessage("Por favor, selecione um modelo para chat normal.", 'ai');
                        return;
                    }
                    const response = await puter.ai.chat(currentConversation, {model: currentModel});
                    addMessage(response, 'ai');
                    currentConversation.push({role: 'assistant', content: response});
                }
            } catch (error) {
                console.error("Erro na API:", error);
                addMessage("Desculpe, ocorreu um erro ao processar sua mensagem.", 'ai');
            } finally {
                loading.style.display = 'none';
                saveConversation();
            }
        }
        
        // Função para adicionar mensagem ao chat (versão padrão)
        function addMessage(text, sender) {
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.textContent = text;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // Função para adicionar mensagem com conteúdo de mídia e botão de download
        function addMessageWithDownload(url, sender, type, textContent = '') {
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            
            if (type === 'image') {
                const img = document.createElement('img');
                img.src = url;
                img.alt = textContent || 'Imagem gerada pela IA';
                messageDiv.appendChild(img);

                const downloadBtn = document.createElement('button');
                downloadBtn.classList.add('download-button');
                downloadBtn.textContent = 'Baixar Imagem';
                downloadBtn.onclick = () => downloadFile(url, `imagem_ia_${Date.now()}.png`);
                messageDiv.appendChild(downloadBtn);

            } else if (type === 'audio') {
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = url;
                messageDiv.appendChild(audio);
                
                // Texto opcional abaixo do player de áudio
                if (textContent) {
                    const textSpan = document.createElement('span');
                    textSpan.textContent = ` "${textContent}"`;
                    messageDiv.appendChild(textSpan);
                }

                const downloadBtn = document.createElement('button');
                downloadBtn.classList.add('download-button');
                downloadBtn.textContent = 'Baixar Áudio';
                downloadBtn.onclick = () => downloadFile(url, `audio_ia_${Date.now()}.mp3`); 
                messageDiv.appendChild(downloadBtn);
            } else if (type === 'video') {
                const video = document.createElement('video');
                video.controls = true;
                video.src = url;
                video.loop = true; // Vídeos de IA costumam ser curtos, loop pode ajudar
                messageDiv.appendChild(video);

                if (textContent) {
                    const textSpan = document.createElement('span');
                    textSpan.textContent = ` "${textContent}"`;
                    messageDiv.appendChild(textSpan);
                }

                const downloadBtn = document.createElement('button');
                downloadBtn.classList.add('download-button');
                downloadBtn.textContent = 'Baixar Vídeo';
                downloadBtn.onclick = () => downloadFile(url, `video_ia_${Date.now()}.mp4`); // Assumindo mp4
                messageDiv.appendChild(downloadBtn);
            }
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // Função para iniciar o download
        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            // Revogar a URL do Blob após o download para liberar memória
            if (url.startsWith('blob:')) {
                URL.revokeObjectURL(url);
            }
        }
        
        // --- Nova Função: generateVideoWithCometAPI ---
        async function generateVideoWithCometAPI(prompt) {
            addMessage(`Gerando vídeo para: "${prompt}"... Isso pode levar um tempo.`, 'ai');
            const requestBody = {
                "model": "veo3-pro",
                "stream": false, // Alterei para false para tentar obter o URL final de uma vez
                "messages": [
                    {
                        "role": "user",
                        "content": prompt // A API espera a descrição diretamente aqui
                    }
                ]
            };

            // Você pode adicionar a lógica de "upsample" aqui se desejar
            // if (prompt.toLowerCase().startsWith('upsample ')) {
            //     requestBody.messages[0].content = prompt; // Assume que a API entende "upsample" no prompt
            // }

            try {
                const response = await fetch(COMETAPI_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${COMETAPI_KEY}` // Tentativa de autenticação
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Erro na CometAPI! Status: ${response.status}, Resposta: ${errorText}`);
                    addMessage(`❌ Erro ao gerar vídeo: ${response.status} - ${errorText}. Verifique o console.`, 'ai');
                    return;
                }

                const data = await response.json();
                console.log("Resposta da CometAPI:", data);

                let videoUrl = null;
                // Tentativas de encontrar o URL do vídeo na resposta (baseado em padrões comuns)
                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    // Se o URL estiver embutido no texto da resposta (e.g., "Aqui está seu vídeo: [URL]")
                    // Isso é uma suposição, a API real pode ter um formato diferente.
                    const content = data.choices[0].message.content;
                    const urlRegex = /(https?:\/\/[^\s]+[.mp4|.mov|.webm])/; // Regex simples para URLs de vídeo
                    const match = content.match(urlRegex);
                    if (match) {
                        videoUrl = match[0];
                    }
                } else if (data.url) { // Alguns APIs retornam o URL diretamente no campo 'url'
                    videoUrl = data.url;
                } else if (data.video_url) { // Ou no campo 'video_url'
                    videoUrl = data.video_url;
                }
                // Você pode precisar ajustar esta lógica de parsing de acordo com a resposta real da API

                if (videoUrl) {
                    addMessageWithDownload(videoUrl, 'ai', 'video', `Vídeo gerado: "${prompt}"`);
                    currentConversation.push({role: 'assistant', content: `[Vídeo gerado: ${prompt}]`, url: videoUrl, type: 'video'});
                } else {
                    addMessage("Não consegui encontrar o URL do vídeo na resposta da API. Verifique o console para mais detalhes.", 'ai');
                    currentConversation.push({role: 'assistant', content: `[Vídeo gerado (URL não encontrada): ${prompt}]`, type: 'video'});
                }

            } catch (error) {
                console.error("Erro ao chamar CometAPI:", error);
                addMessage("Ocorreu um erro ao conectar ou processar a resposta da API de vídeo. Verifique sua conexão e o console.", 'ai');
            }
        }
        // --- Fim da Nova Função ---

        // Função para salvar conversa no histórico
        function saveConversation() {
            if (currentConversation.length === 0) return;
            
            const conversation = {
                id: Date.now(),
                model: currentModel,
                title: currentConversation[0].content.substring(0, 30) + (currentConversation[0].content.length > 30 ? "..." : ""),
                messages: currentConversation.map(msg => {
                    // Ao salvar, apenas armazene o texto do prompt/resposta e, se houver, a URL e tipo
                    const savedMsg = { role: msg.role, content: msg.content };
                    if (msg.url) savedMsg.url = msg.url;
                    if (msg.type) savedMsg.type = msg.type;
                    return savedMsg;
                }),
                timestamp: new Date().toISOString()
            };
            
            // Adicionar ao histórico
            conversationHistory.unshift(conversation);
            
            // Manter apenas as últimas 20 conversas
            if (conversationHistory.length > 20) {
                conversationHistory = conversationHistory.slice(0, 20);
            }
            
            // Salvar no localStorage
            localStorage.setItem('alloneai_conversations', JSON.stringify(conversationHistory));
            
            // Atualizar lista de histórico
            updateHistoryList();
        }
        
        // Função para carregar histórico do localStorage
        function loadConversationHistory() {
            const saved = localStorage.getItem('alloneai_conversations');
            if (saved) {
                conversationHistory = JSON.parse(saved);
                updateHistoryList();
            }
        }
        
        // Função para atualizar a lista de histórico
        function updateHistoryList() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            conversationHistory.forEach(conv => {
                const item = document.createElement('div');
                item.classList.add('history-item');
                item.innerHTML = `
                    <strong>${conv.title}</strong><br>
                    <small>${models[conv.model]?.name || conv.model || 'N/A'} • ${new Date(conv.timestamp).toLocaleString()}</small>
                `;
                
                item.addEventListener('click', () => {
                    loadConversation(conv);
                });
                
                historyList.appendChild(item);
            });
        }
        
        // Função para carregar uma conversa do histórico
        function loadConversation(conversation) {
            const chatHistory = document.getElementById('chat-history');
            chatHistory.innerHTML = '';
            
            currentConversation = []; // Limpa e reconstrói a conversa atual
            currentModel = conversation.model;
            
            // Atualizar seletor de modelo
            document.getElementById('model-selector').value = currentModel;
            document.getElementById('model-info').innerHTML = `
                <strong>${models[currentModel]?.name || currentModel || 'N/A'}</strong><br>
                ${models[currentModel]?.description || 'Sem descrição disponível'}
            `;
            
            // Mostrar todas as mensagens da conversa
            conversation.messages.forEach(msg => {
                currentConversation.push(msg); // Adiciona ao currentConversation para manter o contexto
                if (msg.type === 'image' && msg.url) {
                    addMessageWithDownload(msg.url, 'ai', 'image');
                } else if (msg.type === 'audio' && msg.url) {
                    addMessageWithDownload(msg.url, 'ai', 'audio', msg.content.replace('[Áudio reproduzido: ', '').slice(0, -1));
                } else if (msg.type === 'video' && msg.url) {
                    addMessageWithDownload(msg.url, 'ai', 'video', msg.content.replace('[Vídeo gerado: ', '').slice(0, -1));
                }
                else {
                    addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai');
                }
            });
        }
    </script>
</body>
</html>
